# MT5数据更新系统技术文档

## 1. 系统架构

MT5数据更新系统是一个专为量化交易设计的工具，用于自动从MetaTrader 5平台获取历史数据和实时行情数据。系统分为**历史数据管理**和**实时数据更新**两个核心组件。

### 1.1 核心组件

1. **历史数据管理器** (`src/history_updater.py`)
   - 负责下载和管理多交易品种、多周期的历史K线数据
   - 执行数据完整性检查和验证
   - 支持增量更新

2. **实时数据更新器** (`src/realtime_updater.py`)
   - 实时获取当前最新行情数据
   - 多线程并行处理多个交易品种和周期
   - 计算K线完成度

3. **主控制器** (`src/updater.py`)
   - 提供统一的启动入口
   - 支持命令行参数配置
   - 可单独启动历史或实时组件

4. **MT5 EA** (`mt5/mql5/Experts/MT5DataUpdater_Simple.mq5`)
   - 提供MT5内部的数据获取和更新功能
   - 可配置作为替代方案使用

### 1.2 数据流程图

```
[MT5平台] ──────► [历史数据管理器] ──────► [历史数据文件]
                                             ▲
                                             │
                                             │
                                             ▼
[MT5平台] ──────► [实时数据更新器] ──────► [实时数据文件] ──────► [交易策略]
```

## 2. 历史数据管理详解

### 2.1 文件：`src/history_updater.py`

#### 2.1.1 初始化与配置

```python
def __init__(self, symbols=None, timeframes=None):
```

- **支持的交易品种**：默认支持XAUUSD, XAGUSD, EURUSD, GBPUSD, USDJPY, USDCHF, AUDUSD, NZDUSD, USDCAD
- **支持的时间周期**：M1, M5, M15, M30, H1, H4, D1
- 可通过参数自定义交易品种和时间周期

#### 2.1.2 历史数据下载详情

历史数据下载会根据时间周期自动选择合适的时间范围：

- **日线数据(D1)**：默认下载**最近5年**的数据
  - 起始时间：当前时间 - 5年
  - 下载量：约1825条记录

- **小时线数据(H1, H4)**：默认下载**最近1年**的数据
  - H1起始时间：当前时间 - 1年
  - H1下载量：约8760条记录
  - H4起始时间：当前时间 - 1年
  - H4下载量：约2190条记录

- **分钟线数据(M1, M5, M15, M30)**：默认下载**最近1个月**的数据
  - M1起始时间：当前时间 - 30天
  - M1下载量：约43200条记录(取决于交易时间)
  - M5起始时间：当前时间 - 30天
  - M5下载量：约8640条记录
  - M15起始时间：当前时间 - 30天
  - M15下载量：约2880条记录
  - M30起始时间：当前时间 - 30天
  - M30下载量：约1440条记录

对于已有的数据文件，系统会执行增量更新，即：
1. 读取现有文件中的最后一条记录时间
2. 只下载该时间点之后的新数据
3. 将新数据合并到现有文件中

#### 2.1.3 数据获取方法

系统使用MT5 API获取历史数据：

```python
rates = mt5.copy_rates_range(
    symbol,           # 交易品种
    timeframe,        # 时间周期
    start_time,       # 起始时间
    datetime.now(timezone)  # 当前时间
)
```

获取的数据包含以下字段：
- time: 时间戳
- open: 开盘价
- high: 最高价
- low: 最低价
- close: 收盘价
- tick_volume: Tick数量
- spread: 点差

#### 2.1.4 数据文件处理

历史数据更新过程：

1. **检查文件是否存在**：
   - 不存在时创建新文件
   - 存在时读取现有数据

2. **备份原始文件**：
   - 每次更新前创建`.bak`备份文件
   - 保证数据安全

3. **合并数据**：
   - 合并现有数据和新数据
   - 去除重复时间戳的记录
   - 按时间排序

4. **数据完整性验证**：
   - 检查时间序列是否连续
   - 检测数据缺口
   - 判断是否有异常的时间间隔

数据完整性验证规则：
- 比较相邻K线时间差与预期时间间隔
- 对于M1数据，每条记录间隔应为1分钟
- 对于M5数据，每条记录间隔应为5分钟
- 以此类推

#### 2.1.5 文件命名与存储路径

历史数据文件命名规则：`SYMBOL_timeframe.csv`

例如：
- `XAUUSD_m1.csv` (黄金1分钟数据)
- `EURUSD_h1.csv` (欧元美元1小时数据)

存储路径：`data/historical/SYMBOL/`

## 3. 实时数据更新详解

### 3.1 文件：`src/realtime_updater.py`

#### 3.1.1 初始化与配置

实时数据更新器支持与历史数据管理器相同的交易品种和时间周期。

#### 3.1.2 实时数据更新详情

实时数据更新采用**多线程**方式，为每个品种-周期组合创建一个独立的更新线程，更新频率会根据周期自动调整：

- **M1（1分钟）**：每1秒更新一次
- **M5（5分钟）**：每5秒更新一次
- **M15（15分钟）**：每15秒更新一次
- **M30（30分钟）**：每30秒更新一次
- **H1（1小时）**：每60秒更新一次
- **H4（4小时）**：每300秒更新一次
- **D1（1天）**：每1800秒更新一次

#### 3.1.3 数据获取方法

实时数据使用不同的API调用方式：

```python
rates = mt5.copy_rates_from_pos(
    symbol,           # 交易品种
    timeframe_value,  # 时间周期
    0,                # 从最新的K线开始
    100               # 获取最近100根K线
)
```

这种方法能获取最新的行情数据，包括当前正在形成的K线。

#### 3.1.4 K线完成度计算

实时数据的特殊功能是计算当前K线的完成度，计算方法：

```python
elapsed = (now - last_bar_time).total_seconds()
total = (next_bar_time - last_bar_time).total_seconds()
completion = min(1.0, max(0.0, elapsed / total))
```

这个完成度值是策略判断是否可以基于最新K线执行交易的重要依据。完成度为1.0（或100%）表示K线已完成。

#### 3.1.5 文件命名与存储路径

实时数据文件命名规则：`SYMBOL_timeframe_realtime.csv`

例如：
- `XAUUSD_m1_realtime.csv`
- `EURUSD_h1_realtime.csv`

存储路径：`data/realtime/SYMBOL/`

## 4. 系统控制与启动

### 4.1 文件：`src/updater.py`

#### 4.1.1 命令行参数

系统提供以下命令行参数：

```
--mode [history|realtime|both]  # 更新模式，默认both
--symbols SYMBOLS               # 交易品种，逗号分隔
--timeframes TIMEFRAMES         # 时间周期，逗号分隔
```

启动方式示例：

```bash
# 启动所有服务与默认参数
python src/updater.py

# 只更新历史数据
python src/updater.py --mode history

# 只更新指定品种的实时数据
python src/updater.py --mode realtime --symbols XAUUSD,EURUSD

# 只更新黄金的1分钟和1小时数据
python src/updater.py --symbols XAUUSD --timeframes M1,H1
```

#### 4.1.2 模块加载

系统使用动态加载方式运行更新器：

```python
def load_module(file_path, module_name):
    """动态加载Python模块"""
    spec = importlib.util.spec_from_file_location(module_name, file_path)
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module
```

这种方式允许根据命令行参数灵活地加载和运行不同的更新组件。

## 5. MT5 EA实现

### 5.1 文件：`mt5/mql5/Experts/MT5DataUpdater_Simple.mq5`

#### 5.1.1 EA配置参数

EA提供以下可配置参数：

- **交易品种列表**：以逗号分隔的交易品种列表
- **时间周期列表**：以逗号分隔的时间周期列表
- **数据根目录**：数据存储位置
- **更新频率**：EA更新数据的间隔（分钟）
- **历史K线数量**：获取的历史K线数量
- **是否启用Tick更新**：是否支持当前图表品种的实时Tick更新
- **是否启用日志**：是否记录详细日志
- **交易时段设置**：设置EA在哪些时段更新数据

#### 5.1.2 EA工作流程

EA通过以下事件驱动工作：

1. **OnInit**：
   - 检查交易权限
   - 创建数据目录
   - 设置定时器

2. **OnTimer**：
   - 周期性根据配置的频率处理所有品种和周期
   - 下载数据并保存到CSV文件

3. **OnTick**：
   - 对当前图表品种进行更频繁的更新
   - 保障交易策略有最新数据

#### 5.1.3 数据存储方式

EA直接将数据存储在MT5的Files目录下：
`[MT5安装路径]/MQL5/Files/[数据根目录]/...`

## 6. 数据文件格式详解

### 6.1 历史数据文件

历史数据以CSV格式存储，包含以下列：

| 列名 | 数据类型 | 说明 |
|-----|---------|-----|
| time | datetime | 时间戳（ISO格式）|
| open | float | 开盘价 |
| high | float | 最高价 |
| low | float | 最低价 |
| close | float | 收盘价 |
| volume | int | 成交量（Tick数） |
| spread | int | 点差 |

### 6.2 实时数据文件

实时数据文件在历史数据的基础上添加以下列：

| 列名 | 数据类型 | 说明 |
|-----|---------|-----|
| completed | float | K线完成度（0.0-1.0） |

## 7. 使用示例与最佳实践

### 7.1 完整历史数据初始下载

首次使用系统时，推荐先执行完整历史数据下载：

```bash
python src/updater.py --mode history
```

这会为所有默认交易品种和时间周期下载完整的历史数据，时间范围如下：
- 日线(D1)：过去5年
- 小时线(H1, H4)：过去1年
- 分钟线(M1, M5, M15, M30)：过去1个月

### 7.2 快速获取黄金数据示例

只下载黄金(XAUUSD)的历史和实时数据：

```bash
python src/updater.py --symbols XAUUSD
```

### 7.3 实时交易数据更新

在策略交易期间，推荐只运行实时数据更新：

```bash
python src/updater.py --mode realtime
```

### 7.4 定时历史数据同步

建议每日交易结束后执行一次历史数据同步，确保历史数据完整：

```bash
python src/updater.py --mode history
```

## 8. 性能与资源管理

### 8.1 数据量估算

各时间周期的大致数据量：

| 时间周期 | 1个月数据量 | 1年数据量 | 5年数据量 | 文件大小估算 |
|--------|----------|----------|----------|------------|
| M1 | ~43200条 | ~518400条 | ~2592000条 | 50-150MB/年 |
| M5 | ~8640条 | ~103680条 | ~518400条 | 10-30MB/年 |
| M15 | ~2880条 | ~34560条 | ~172800条 | 3-10MB/年 |
| M30 | ~1440条 | ~17280条 | ~86400条 | 2-5MB/年 |
| H1 | ~720条 | ~8640条 | ~43200条 | 1-3MB/年 |
| H4 | ~180条 | ~2160条 | ~10800条 | 200-600KB/年 |
| D1 | ~30条 | ~365条 | ~1825条 | 30-100KB/年 |

注意：实际数据量取决于交易品种的交易时间和市场开放日。

### 8.2 CPU和内存使用

- **历史数据更新**：短时间CPU使用率较高，但总耗时有限
- **实时数据更新**：长期低CPU使用，内存占用稳定
- **多品种并行更新**：会增加内存使用，但通常不超过500MB

### 8.3 网络带宽使用

- **历史数据初始下载**：根据品种和周期，数据量可达数十至数百MB
- **实时数据更新**：带宽使用极小，通常每次更新不超过几KB

## 9. 故障排除与常见问题

### 9.1 MT5连接问题

如果出现MT5连接失败：

1. 确保MT5客户端已启动并登录
2. 检查"允许自动交易"已启用
3. 检查"允许DLL导入"已启用
4. 确保没有其他程序已连接到MT5
5. 重启MT5客户端后再试

### 9.2 历史数据缺口

系统会检测并警告可能的数据缺口。常见原因：

1. 市场休市期间（周末、节假日）
2. 交易品种特定的交易时间限制
3. 经纪商数据源临时中断

处理方法：
- 小的数据缺口系统会在日志中标记，通常不需处理
- 大的数据缺口可能需要手动干预，例如重新下载特定时间范围的数据

### 9.3 文件权限问题

如果出现文件无法创建或写入：

1. 检查程序运行用户对目标目录是否有写入权限
2. 检查文件是否被其他程序锁定
3. 尝试以管理员权限运行程序

## 10. 系统扩展

### 10.1 增加新交易品种

要添加新的交易品种，修改默认列表或通过参数指定：

```python
# 在代码中修改默认列表
self.default_symbols = [
    'XAUUSD',
    'XAGUSD',
    # 添加新品种
    'BTCUSD',
    'ETHUSD'
]

# 或者通过命令行参数
python src/updater.py --symbols XAUUSD,XAGUSD,BTCUSD,ETHUSD
```

### 10.2 增加新时间周期

系统已支持主要时间周期。如需添加非标准周期，需修改代码中的时间周期配置。

### 10.3 自定义数据处理

可通过扩展现有类或创建新模块实现自定义数据处理：

```python
# 扩展示例
class CustomHistoryUpdater(HistoryUpdater):
    def __init__(self, symbols=None, timeframes=None):
        super().__init__(symbols, timeframes)
        
    def custom_processing(self, data):
        # 自定义处理逻辑
        pass
```

## 11. 系统维护

### 11.1 日志管理

系统日志存储在以下位置：
- 历史数据日志：`data/logs/history_updater.log`
- 实时数据日志：`data/logs/realtime_updater.log`

建议定期检查日志，特别关注：
- ERROR级别消息
- 数据验证警告
- MT5连接问题

### 11.2 数据备份

系统在每次更新前会自动创建备份文件（.bak后缀）。
建议额外定期备份整个数据目录。

### 11.3 定期维护任务

1. **每周**：检查日志文件大小，过大时进行归档
2. **每月**：验证所有数据文件的完整性
3. **每季度**：检查硬盘空间使用情况

## 12. 系统更新日志

### v1.0.0 (2023-06-15)
- 初始版本发布
- 支持历史数据和实时数据更新
- 支持9种交易品种和7种时间周期 