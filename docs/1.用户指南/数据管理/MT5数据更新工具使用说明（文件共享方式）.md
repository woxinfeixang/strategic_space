# MT5数据更新工具使用说明（文件共享方式）

## 概述

本工具采用文件共享方式，允许MT5与本地数据服务之间进行通信，不依赖于网络请求（WebRequest）。这种方式更为可靠，不受MT5网络权限限制，适合所有用户使用。

## 系统组件

系统由两个主要部分组成：

1. **MT5数据更新器EA（MT5DataUpdater_Simple.mq5）**
   - 在MT5中运行的EA
   - 通过文件共享与本地数据服务通信
   - 定时或实时触发数据更新

2. **本地文件监视器（watch_command_file.py）**
   - 在本地运行的Python服务
   - 监视MT5写入的命令文件
   - 执行相应的数据更新操作
   - 将结果写回响应文件

## 安装步骤

### 1. 安装前准备

确保系统满足以下条件：

- 已安装MT5（MetaTrader 5）
- 已安装Python 3.6或更高版本
- 安装了pandas库（安装脚本会自动安装）

### 2. 运行安装脚本

1. 找到`install_mt5_data_updater_simple.bat`
2. 双击运行该批处理文件
3. 安装脚本将：
   - 复制EA文件到MT5目录
   - 安装必要的Python依赖
   - 尝试自动编译EA文件

### 3. 启动本地文件监视器

1. 转到`mt5_data_updater`目录
2. 双击运行`start_file_watcher.bat`
3. 确保文件监视器保持运行状态

### 4. 在MT5中配置EA

1. 启动MT5
2. 打开任意图表
3. 在导航窗口中找到"专家顾问" > "MT5DataUpdater_Simple"
4. 将EA拖放到图表上
5. 配置EA参数：
   - `Symbols`：交易品种列表（逗号分隔）
   - `Timeframes`：时间周期列表（逗号分隔）
   - `DataPath`：数据保存路径
   - `UpdateFrequencyMinutes`：更新频率（分钟）
   - `EnableTickUpdate`：是否启用Tick更新
   - `EnableLogging`：是否启用日志记录
   - `TradingHourStart`/`TradingHourEnd`：交易时段设置
   - `OnlyUpdateDuringTradingHours`：是否仅在交易时段更新

6. 确认EA设置并单击"确定"

### 5. 激活EA

1. 在图表上右键点击
2. 选择"专家顾问" > "启用EA自动交易"
3. 确保图表右上角显示笑脸图标

## 工作原理

EA和本地服务之间的通信通过两个文件实现：

1. **命令文件**：MT5 EA写入，包含要执行的命令和配置
2. **响应文件**：本地服务写入，包含命令执行的结果

数据更新流程：

1. EA根据定时器或Tick事件触发更新
2. EA将命令写入命令文件
3. 本地服务检测到命令文件变化
4. 本地服务执行相应的数据更新操作
5. 本地服务将结果写入响应文件
6. EA读取响应文件获取更新状态

## 日志和故障排除

### EA日志

在MT5"专家"选项卡中可以查看EA的日志输出，包括：
- 命令发送记录
- 响应接收记录
- 错误信息等

### 本地服务日志

本地服务日志保存在`mt5_file_watcher.log`文件中，记录：
- 服务启动和停止信息
- 命令处理记录
- 数据更新操作
- 错误信息等

### 常见问题解决

1. **EA无法发送命令**
   - 检查MT5权限设置
   - 确认Files目录存在且可写

2. **本地服务未启动**
   - 检查Python是否正确安装
   - 确认依赖库是否安装成功

3. **数据更新不成功**
   - 检查EA参数设置
   - 查看日志文件中的错误信息

## 定制和扩展

### 扩展数据处理

如需实现自定义数据处理逻辑，可修改`watch_command_file.py`中的相关函数：
- `_simulate_data_update()`：替换为实际的数据获取与处理逻辑
- `_update_data()`：自定义批量更新逻辑
- `_update_symbol_data()`：自定义单品种更新逻辑

### 自定义响应格式

可以根据需要修改`_write_response()`函数，调整响应格式。

## 注意事项

1. 请确保先启动本地文件监视器，再在MT5中启用EA
2. EA和本地服务必须访问相同的文件位置
3. 如在MT5中关闭或移除EA，建议也停止本地文件监视器服务
4. 数据路径设置建议使用绝对路径，避免路径解析问题 