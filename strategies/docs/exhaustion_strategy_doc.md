# 衰竭策略 (Exhaustion Strategy) 说明文档

**重要: 时区处理**

*   本策略接收的市场价格 K 线数据 (来自 `MarketDataProvider`)，其时间索引为 **UTC 时间**。
*   本策略接收的财经日历事件数据 (来自 `EconomicCalendarProvider`)，其时间列为 **北京时间 (`Asia/Shanghai`)**。
*   在策略的 `process_new_data` 方法内部，会**自动将接收到的事件时间转换为 UTC**，以便后续所有的时间比较、动能分析和逻辑判断都在 **统一的 UTC 时间基准**下进行。

## 1. 策略依据

本策略的核心思想来源于《外汇交易面授总结》PDF文档中关于 **"动能衰竭"** 的论述。

*   **衰竭信号**: PDF文档（如图T3-21）指出，当价格运行至博弈空间边界附近时，如果出现特定价格行为和技术指标特征，往往表明当前趋势动能衰竭，可能即将反转。
*   **策略目标**: 本策略旨在识别这些衰竭信号，在边界附近捕捉高概率的反转交易机会。

## 2. 实现逻辑

该策略 (`exhaustion_strategy.py`) 继承自 `EventDrivenSpaceStrategy`，并主要通过重写 `_execute_trading_logic` 方法来实现其特定的衰竭信号识别和交易执行逻辑。它完全依赖父策略进行博弈空间的创建、管理和失效判断，以及基础的数据处理和订单执行功能。

*   **继承与空间**: 自动继承父类创建和管理博弈空间的能力。衰竭信号的判断均在父策略提供的有效空间边界附近进行。
*   **边界接近检测 (`_check_boundary_proximity`)**:
    *   判断价格是否接近空间边界（上边界或下边界15点范围内）。
    *   标记为 `near_upper_boundary` 或 `near_lower_boundary`。
*   **动能衰竭检测 (`_detect_exhaustion`)**:
    *   **价格行为特征**:
        1.  **长影线K线**: 上影线/下影线超过实体2倍（表明价格被拒绝）。
        2.  **连续小实体K线**: 最近3根K线实体小于平均实体50%。
        3.  **成交量萎缩**: 当前成交量低于过去5根K线平均成交量70%。
    *   **技术指标确认**:
        1.  **RSI背离**:
            *   价格创新高但RSI未创新高（上边界）。
            *   价格创新低但RSI未创新低（下边界）。
        2.  **MACD柱状图收缩**: 最近3根柱状图高度递减。
    *   每种特征返回一个置信度分数 (0-1)。
*   **信号确认 (`_confirm_signal`)**:
    *   要求同时满足：
        1.  处于边界附近 (`near_upper_boundary` 或 `near_lower_boundary`)。
        2.  至少2种衰竭特征的置信度 > 0.7。
        3.  当前K线收盘价保持在边界内侧。
    *   有效信号标记为 `valid_exhaustion_signal`。
*   **入场逻辑**:
    *   在执行任何新的入场判断前，策略会通过 `self.execution_engine.get_position(symbol)` 检查当前交易品种是否已有持仓。只有在无持仓或持仓为零时，才会寻找新的入场机会。
    *   如果检测到上边界衰竭信号 (`upper_exhaustion`)，执行卖出市价单。
    *   如果检测到下边界衰竭信号 (`lower_exhaustion`)，执行买入市价单。
*   **止损 (Stop Loss)**:
    *   卖出订单: 空间上边界 (`space_info['high']`) 之上 + 缓冲 (`stop_loss_pip_buffer`)。
    *   买入订单: 空间下边界 (`space_info['low']`) 之下 - 缓冲。
*   **止盈 (Take Profit)**:
    *   止盈目标 (`take_profit_target`) 可配置：
        *   `'opposite_boundary'` (默认): 目标设为博弈空间的对侧边界。
        *   `'ratio'`: 基于入场价和止损价计算固定盈亏比 (`take_profit_ratio`，默认为1.5)。
        *   `'atr_multiple'`: 基于ATR倍数动态计算目标。
*   **子策略复用**: 实例化了 `ReverseCrossoverStrategy` (`_rc_checker`)，用于辅助判断是否同时出现反向穿越信号，以增强衰竭信号的可靠性。

**注意**: 该策略不覆盖父类的 `process_new_data` 方法，而是依赖父类的该方法来驱动 `_execute_trading_logic` 的执行。同时，`_get_pip_size` 等核心辅助方法也直接使用父类的实现。

## 3. 当前限制与未来改进方向

*   **衰竭检测主观**: 当前基于预设规则判断衰竭信号。
    *   **改进**:
        *   引入机器学习模型: 识别复杂衰竭形态。
        *   增加更多价格行为模式: 如Inside Bar集群、假突破等。
*   **信号确认不足**: 当前仅要求基本衰竭条件。
    *   **改进**:
        *   增加更多技术指标确认: 如Stochastic、CCI等。
        *   要求多时间框架共振: 如M30和H1同时出现衰竭信号。
*   **止损止盈固定**: 基于固定点数的缓冲可能不够灵活。
    *   **改进**:
        *   使用ATR动态计算止损盈距离。
        *   根据衰竭强度调整: 强信号可容忍更大回撤。
*   **单一时间框架**: 当前仅使用M30 K线。
    *   **改进**: 结合M5/M15的衰竭信号进行确认：
        *   要求M30和M15同时出现同向信号。
        *   使用M5的短期价格行为确认M30信号。
*   **未考虑多空间影响**: 当价格同时接近多个空间边界时，当前逻辑可能不够精确。
    *   **改进**:
        *   优先处理最近形成的空间边界。
        *   当多个空间边界接近时，结合它们的共同影响调整入场条件。
*   **仓位管理**: 未实现动态仓位 (`_calculate_order_size`)。
    *   **改进**: 根据衰竭信号强度、波动率或空间大小动态调整仓位。

衰竭策略试图捕捉博弈空间边界附近的价格动能衰竭点，当前的实现提供了一个基础框架，但在信号识别的智能化、确认机制的全面性以及风险管理的适应性方面仍有较大的优化空间。
