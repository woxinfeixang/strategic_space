# 博弈空间时间共振策略 (Space-Time Resonance Strategy) 说明文档

**重要: 时区处理**

*   本策略接收的市场价格 K 线数据 (来自 `MarketDataProvider`)，其时间索引为 **UTC 时间**。
*   本策略接收的财经日历事件数据 (来自 `EconomicCalendarProvider`)，其时间列为 **北京时间 (`Asia/Shanghai`)**。
*   在策略的 `process_new_data` 方法内部，会**自动将接收到的事件时间转换为 UTC**，以便后续所有的时间比较、周期分析和逻辑判断都在 **统一的 UTC 时间基准**下进行。

## 1. 策略依据

本策略的核心思想来源于《外汇交易面授总结》PDF文档中关于 **"时间共振"** 的论述。

*   **时间共振概念**: PDF文档（如图T3-23）指出，当价格到达博弈空间边界的同时，时间周期也达到关键转折点时，会产生极高概率的交易机会。这种时空共振表明市场在价格和时间维度同时达到平衡点。
*   **策略目标**: 本策略旨在识别这些时空共振信号，在价格和时间的双重确认下执行交易。

## 2. 实现逻辑

该策略 (`space_time_resonance_strategy.py`) 继承自 `EventDrivenSpaceStrategy`，并主要通过重写 `_execute_trading_logic` 方法来实现其特定的时空共振信号识别和交易执行逻辑。它完全依赖父策略进行博弈空间的创建、管理、失效判断，处理事件与交易品种的映射 (`_map_event_to_symbol`)，查找当前事件相关的活跃空间 (`_find_active_spaces_for_event`)，以及获取如 `pip_size` 这样的核心参数和基础数据处理功能。该策略的 `process_new_data` 方法也直接调用父类的实现，由父类驱动其核心交易逻辑。

*   **继承与空间**: 自动继承父类创建和管理博弈空间的能力。时空共振的判断均在父策略提供的有效空间边界附近进行。
*   **时间周期分析 (`_analyze_time_cycles`)**:
    *   使用快速傅里叶变换(FFT)检测价格序列中的主导周期：
        1.  分析过去200根K线的收盘价序列。
        2.  提取能量最强的3个周期分量。
        3.  标记当前时间在主导周期中的相位位置。
    *   周期转折点定义为相位为0°或180°附近（±5%周期长度）。
    *   **关键时间判断 (`_is_key_time`)**: 此方法用于判断当前是否处于关键时间点，其逻辑已与父策略中处理经济日历事件的 `_is_key_event_time` 方法的原则保持一致，关注配置中定义的事件前后时间窗口。
*   **共振条件检测 (`_check_resonance_conditions`)**:
    *   要求同时满足：
        1.  **空间条件**: 价格接近空间边界（上边界或下边界15点内）。
        2.  **时间条件**: 当前时间处于主导周期转折点附近。
        3.  **确认条件**: 最近3根K线显示动能减弱（如实体缩小、成交量下降）。
    *   共振信号标记为 `valid_resonance_signal`。
*   **信号强度评估 (`_evaluate_signal_strength`)**:
    *   根据以下因素计算信号强度 (0-1)：
        1.  **周期显著性**: 主导周期能量占总能量的比例。
        2.  **空间显著性**: 该边界被测试的次数和历史反应强度。
        3.  **确认指标**: RSI、MACD等技术指标的背离程度。
    *   信号强度用于动态调整仓位大小。
*   **入场逻辑**:
    *   如果检测到上边界共振信号 (`upper_resonance`)，执行卖出市价单。
    *   如果检测到下边界共振信号 (`lower_resonance`)，执行买入市价单。
    *   入场前检查当前无持仓。
*   **止损 (Stop Loss)**:
    *   动态止损基于ATR倍数 (`atr_multiplier`，默认为1.5)。
    *   卖出订单: 入场价 + ATR×倍数。
    *   买入订单: 入场价 - ATR×倍数。
*   **止盈 (Take Profit)**:
    *   止盈目标 (`take_profit_target`) 可配置：
        *   `'opposite_boundary'` (默认): 目标设为博弈空间的对侧边界。
        *   `'cycle_target'`: 基于周期理论计算目标（如1/2周期长度）。
        *   `'atr_multiple'`: 基于ATR倍数动态计算目标。
*   **子策略复用**: 实例化了 `KeyTimeWeightTurningPointStrategy` (`_kt_checker`)，用于辅助判断是否同时出现权重拐点信号，以增强共振信号的可靠性。

**注意**: 配置参数（如周期分析参数、共振确认参数等）均从策略配置中正确读取。父类 `EventDrivenSpaceStrategy` 中关于S2阶段（处理特定事件驱动的空间创建和管理）的逻辑已覆盖本策略可能涉及的事件处理需求，因此本策略无需重复实现相关 `TODO`。

## 3. 当前限制与未来改进方向

*   **周期检测局限**: 当前傅里叶变换对非稳态价格序列敏感。
    *   **改进**:
        *   加入小波变换: 更好处理非稳态信号。
        *   尝试希尔伯特-黄变换(HHT): 自适应分解非线性信号。
*   **共振判断简单**: 当前仅考虑单一主导周期。
    *   **改进**:
        *   分析多周期共振: 要求短、中、长周期同时达到转折。
        *   加入周期相位同步分析: 确保各周期相位一致。
*   **未考虑市场状态**: 不同市场环境下周期可靠性不同。
    *   **改进**:
        *   加入市场状态过滤器: 区分趋势/震荡市。
        *   根据ADX值调整周期权重: 高ADX时侧重趋势周期。
*   **信号强度计算**: 当前线性组合可能不够理想。
    *   **改进**:
        *   使用机器学习模型: 学习各因素的最佳权重。
        *   非线性映射: 如Sigmoid函数转换综合评分。
*   **单一时间框架**: 当前仅使用M30 K线。
    *   **改进**: 结合M5/M15的周期分析：
        *   要求M30和M15周期同步。
        *   使用M5的短期周期确认M30信号。
*   **仓位管理**: 当前信号强度与仓位线性相关。
    *   **改进**: 非线性仓位映射，如：
        *   阈值控制: 仅当信号强度>0.7才交易。
        *   分段线性: 不同强度区间不同仓位系数。
*   **未考虑日历事件**: 重要财经事件可能干扰周期。
    *   **改进**: 在事件窗口期暂停周期分析或调整参数。

博弈空间时间共振策略试图捕捉时空维度同时确认的高概率交易机会，当前的实现提供了一个基础框架，但在周期检测的准确性、共振判断的全面性以及仓位管理的精细化方面仍有较大的优化空间。
